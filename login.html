<!DOCTYPE html>
<html lang="pt-br" dir="ltr">
<head>
  <!-- Define o conjunto de caracteres como UTF-8 -->
  <meta charset="UTF-8">
  
  <!-- Configura a viewport para dispositivos móveis -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Importa a biblioteca SweetAlert2 para alertas bonitos -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Importa o jQuery 3.6 para facilitar manipulação de DOM e AJAX -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- Título da página -->
  <title>Login AutoPrime</title>
  
  <!-- Importa a fonte Poppins do Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <!-- Importa o CSS principal da página -->
  <link rel="stylesheet" href="assets/css/style.css">

  <!-- Estilos adicionais específicos para o login -->
  <style>
    /* Container da senha para posicionamento relativo do ícone */
    .password-container { position: relative; width: 100%; }

    /* Ícone para mostrar/ocultar a senha */
    .toggle-password {
      position: absolute;
      top: 20px;
      right: 30px;
      transform: translateY(-50%);
      cursor: pointer;
      width: 22px;
      height: 22px;
      pointer-events: auto;
      fill: #555;
    }

    /* Garantir que SweetAlert não bloqueie interação por engano */
    .swal2-container, .swal2-backdrop { pointer-events: auto !important; z-index: 9999 !important; }

    /* Estilo de botão desativado */
    .btn-cadastro[disabled] { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body class="body-cadastro">
  <!-- Div principal do login -->
  <div class="div-mae-login">
    <div>
      <!-- Frases motivacionais no topo -->
      <h2 class="frase-cadastro">Acesso exclusivo para</h2>
      <h2 class="frase2-cadastro">quem respira performance.</h2>
    </div>

    <div>
      <!-- Card central do login -->
      <div class="card-login center">
        <h1 class="tit-cadastro">Login</h1>
        <!-- Formulário de login -->
        <form id="formlgn" autocomplete="off" novalidate>
          <!-- Campo de email -->
          <input class="input-cadastro" type="email" id="email" name="email" placeholder="Email" required>

          <!-- Campo de senha com ícone de toggle -->
          <div class="password-container">
            <input class="input-cadastro" type="password" id="senha" name="senha" placeholder="Senha" required aria-label="senha">
            <!-- Ícone de olho para mostrar/ocultar senha -->
            <svg class="toggle-password" id="togglePassword" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="button" aria-label="Mostrar/ocultar senha" tabindex="0">
              <path id="eyePath" d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
            </svg>
          </div>

          <!-- Aviso de política de privacidade -->
          <p class="p-cadastro">Ao continuar você concorda com nossos<br><a href="politicaprivada.html" style="color: #008CFF;">Termos de Política e Privacidade</a></p>

          <!-- Botão de login -->
          <button class="btn-cadastro" id="btnEntrar"  type="submit">Entrar</button>

          <!-- Link de recuperação de senha -->
          <a class="p-cadastro" id="linkEsqueci" style="font-weight: 600; position: absolute; top: 535px; right: 343px; cursor: pointer;">Esqueci minha senha</a>
        </form>
      </div>

      <!-- Link para cadastro de nova conta -->
      <p class="sub-p">Não tem uma conta? <a style="font-weight: 700; color: white;" href="cadastro.html">Cadastre-se</a></p>
    </div>
  </div>

<script>
  /* Toggle de senha (mantive igual) */
  (function() {
    const senhaInput = document.getElementById('senha');
    const toggle = document.getElementById('togglePassword');
    const eyePath = document.getElementById('eyePath');

    const PATH_OPEN = 'M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z';
    const PATH_CLOSED = 'M2.1 2.1 0.69 3.51 4.06 6.88C3.33 8.63 2 10.22 1 12c1.73 3.89 6 7 11 7 2.17 0 4.19-.57 5.93-1.57l3.24 3.24 1.41-1.41L2.1 2.1zM12 17c-2.76 0-5-2.24-5-5 0-.73.18-1.42.49-2.03l1.6 1.6A3 3 0 0 0 12 15c1.66 0 3-1.34 3-3 0-.53-.15-1.02-.4-1.44l1.43 1.43C16.38 12.85 14.35 13 12 13c-1.02 0-2.01-.1-2.95-.29l1.57 1.57C11.01 14.7 11.99 15 12 15z';
    let visible = false;

    function toggleFunc(e) {
      e && e.preventDefault();
      visible = !visible;
      senhaInput.type = visible ? 'text' : 'password';
      eyePath.setAttribute('d', visible ? PATH_CLOSED : PATH_OPEN);
      senhaInput.focus();
    }

    toggle.addEventListener('click', toggleFunc);
    toggle.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') toggleFunc(e);
    });
  })();


  /* Form submit + AJAX */
  $(function() {
    // Defina a API_BASE sem repetir segmentos de rota
    const API_BASE = ''; // <<-- sem /login aqui
    const $form = $('#formlgn');
    const $btn = $('#btnEntrar');

    function cleanupSwalIfStuck() {
      // uso defensivo — mas tente não precisar disso removendo CSS custom problemática
      document.querySelectorAll('.swal2-container, .swal2-backdrop').forEach(el => {
        if (el && el.parentNode) el.parentNode.removeChild(el);
      });
      document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }

    $form.on('submit', function(e) {
      e.preventDefault();
      if ($btn.prop('disabled')) return;

      const email = $('#email').val().trim();
      const senha = $('#senha').val();

      if (!email || !senha) {
        Swal.fire({ icon: 'warning', title: 'Preencha todos os campos', allowOutsideClick: true, allowEscapeKey: true });
        return;
      }

      const payload = JSON.stringify({ email: email, senha: senha });
      $btn.prop('disabled', true);

      $.ajax({
        method: 'POST',
        url:  'http://192.168.1.123:5000/login', // API_BASE sem /login => resulta em /login corretamente
        data: payload,
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        timeout: 15000,
        success: function(retorno) {
          if (retorno && retorno.token) {
            try {
              localStorage.setItem('token', retorno.token);
              localStorage.setItem('email', retorno.email || '');
              localStorage.setItem('nome', retorno.nome || '');
              localStorage.setItem('id_cadastro', retorno.id_cadastro || '');
              localStorage.setItem('cargo', retorno.cargo || '');
            } catch (err) {
              console.warn('LocalStorage write failed:', err);
            }

            // Modal de sucesso simples — quando o usuário clicar OK, executamos o redirect
            Swal.fire({
              title: 'LOGIN REALIZADO!',
              icon: 'success',
              allowOutsideClick: false,
              allowEscapeKey: true,
              confirmButtonText: 'OK'
            }).then(function() {
              // pega cargo com segurança
              const cargo = (retorno && retorno.cargo) ? retorno.cargo : (localStorage.getItem('cargo') || '');
              try {
                if (cargo === "vendedor") {
                  window.location.href = "indexvendedor.html";
                } else if (cargo === "ADM") {
                  window.location.href = "home.html";
                } else {
                  window.location.href = "index.html";
                }
              } catch (err) {
                console.error('Erro no redirect:', err);
                cleanupSwalIfStuck();
              }
            });

          } else {
            Swal.fire({
              icon: 'error',
              title: 'Erro na resposta',
              text: 'Resposta inválida do servidor. Tente novamente mais tarde.',
              allowOutsideClick: true,
              allowEscapeKey: true
            });
          }
        },
        error: function(jqXHR, textStatus) {
          console.error('AJAX ERROR:', textStatus, jqXHR);
          const message = jqXHR?.responseJSON?.error ||
                          (textStatus === 'timeout' ? 'Tempo de conexão esgotado. Tente novamente.' :
                           (jqXHR.status ? `Erro ${jqXHR.status}: ${jqXHR.statusText}` :
                            'Ocorreu um erro ao conectar com o servidor.'));

          Swal.fire({
            icon: 'error',
            title: 'ERRO',
            text: message,
            allowOutsideClick: true,
            allowEscapeKey: true,
            showConfirmButton: true
          }).then(function() {
            // limpeza defensiva
            cleanupSwalIfStuck();
          });
        },
        complete: function() {
          $btn.prop('disabled', false);
        }
      });
    });

    /* Esqueci minha senha */
    $('#linkEsqueci').on('click', function(e) {
      e.preventDefault();
      Swal.fire({
        title: 'Recuperar senha',
        input: 'email',
        inputLabel: 'Informe seu e-mail cadastrado',
        inputPlaceholder: 'seu@exemplo.com',
        showCancelButton: true,
        confirmButtonText: 'Enviar',
        inputValidator: (value) => { if (!value) return 'Informe um e-mail válido'; },
        allowOutsideClick: true,
        allowEscapeKey: true
      }).then((result) => {
        if (result.isConfirmed && result.value) {
          const emailRec = result.value.trim();
          Swal.showLoading();
          $.ajax({
            method: 'POST',
            url: API_BASE + '/forgot-password',
            data: JSON.stringify({ email: emailRec }),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            timeout: 15000,
            success: function(r) {
              Swal.fire({ icon: 'success', title: 'Enviado', text: r?.message || 'Se o e-mail existir em nosso sistema, você receberá instruções.', allowOutsideClick: true });
            },
            error: function(jqXHR, textStatus) {
              console.error('Forgot PW Error:', textStatus, jqXHR);
              const msg = jqXHR?.responseJSON?.error || 'Não foi possível enviar o e-mail. Tente novamente mais tarde.';
              Swal.fire({ icon: 'error', title: 'Erro', text: msg, allowOutsideClick: true });
            }
          });
        }
      });
    });

  });
</script>
</body>
</html>

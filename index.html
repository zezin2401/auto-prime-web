<!DOCTYPE html>
<html lang="pt-br" dir="ltr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet" />

    <title>Home AutoPrime</title>
    <link rel="stylesheet" href="assets/css/style.css" />

    <!-- mantém seguranca.js se precisar validar token antes de carregar a página -->
    <script src="assets/js/seguranca.js"></script>

    <style>
        /* ===== menu lateral (igual antes) ===== */
        #sideMenu { position: fixed; top: 0; right: -250px; width: 250px; height: 100%; background-color: #222; color: #f0f0f0; box-shadow: -3px 0 8px rgba(0,0,0,0.6); transition: right .3s ease, opacity .3s ease; padding: 30px 25px; font-family:'Poppins',sans-serif; z-index:1000; opacity:0; pointer-events:none; display:flex; flex-direction:column;}
        #sideMenu.active { right:0; opacity:1; pointer-events:auto;}
        #sideMenu .closeBtn{ font-size:28px; font-weight:700; cursor:pointer; text-align:right; margin-bottom:40px; color:#f0f0f0; user-select:none; transition:color .2s;}
        #sideMenu .closeBtn:hover{ color:#ff4d4d;}
        #sideMenu ul{ list-style:none; padding:0; margin:0; flex-grow:1; display:flex; flex-direction:column; gap:25px;}
        #sideMenu ul li{ font-weight:600; font-size:20px;}
        #sideMenu ul li a{ color:#f0f0f0; text-decoration:none; padding:10px 15px; border-radius:8px; display:block;}
        #sideMenu ul li a:hover{ background:#444; color:#ff4d4d;}
        .avatarheader img{ cursor:pointer; }

        /* ===== layout produtos ===== */
        .catalogo-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 18px;
            padding: 30px;
            align-items: start;
        }

        /* Card */
        .meus-produtos {
            background: #fff;
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(12, 23, 40, 0.06);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: transform .15s ease, box-shadow .15s ease;
            min-height: 320px; /* mantém altura estável */
        }
        .meus-produtos:hover { transform: translateY(-6px); box-shadow: 0 18px 36px rgba(12,23,40,0.09); }

        .img-produto {
            width: 100%;
            height: 150px;
            object-fit: contain;
            background: linear-gradient(180deg, #f8f8f8, #ffffff);
            border-radius: 8px;
            border: 1px solid #f0f0f0;
        }

        .card-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1 1 auto;
        }

        .nome-produto {
            font-size: 15px;
            font-weight: 700;
            line-height: 1.2;
            margin: 0;
            /* truncamento elegante até 2 linhas */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.8em;
        }

        .descricao-produto {
            font-size: 13px;
            color: #4b5563;
            margin: 0;
            /* trunca 3 linhas */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .acabamento-produto {
            font-size: 12px;
            color: #6b7280;
            background: rgba(0,0,0,0.03);
            padding: 6px 8px;
            border-radius: 6px;
            display: inline-block;
            max-width: 100%;
        }

        .rodape-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-top: auto;
        }

        .preco-produto {
            font-size: 16px;
            font-weight: 800;
            color: #111827;
        }

        .btn-comprar {
            padding: 8px 12px;
            border-radius: 8px;
            background: linear-gradient(180deg,#0d6efd,#0b5ed7);
            color: #fff;
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(11,94,215,0.12);
            white-space: nowrap;
        }

        /* tooltip simples (mostra descrição completa) */
        .descricao-produto[title] { cursor: help; }

        /* responsivo */
        @media (max-width: 480px) {
            .img-produto { height: 120px; }
            .meus-produtos { min-height: 300px; }
        }
    </style>
</head>

<body>
    <header>
        <img class="logo" src="assets/img/Ariel.png" alt="Logo" />
        <form onsubmit="event.preventDefault(); listarProdutos();">
            <input class="input-header" id="buscaInput" type="text" placeholder="Buscar na AutoPrime" />
            <button class="header-btninput" type="submit" style="padding:8px; border:none; cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 
                    1.415-1.414l-3.85-3.85zm-5.242.656a5 
                    5 0 1 1 0-10 5 5 0 0 1 0 10z" />
                </svg>
            </button>
        </form>

        <a class="avatarheader" href="#" id="avatarToggle"><img src="assets/img/login 3.png" alt="Avatar" /></a>
    </header>

    <!-- Menu lateral -->
    <nav id="sideMenu">
        <div class="closeBtn" id="menuClose">&times;</div>
        <ul>
            <li><a href="#">Minha Conta</a></li>
            <li><a href="#" id="logoutBtn">Logout</a></li>
        </ul>
    </nav>

    <section>
        <div class="center" style="margin-top: 60px;">
            <img class="banner1" src="assets/img/PONTEIRAS DE (1).png" alt="Banner" />
        </div>

        <div class="d-flex center div-mae-marcas" style="gap:10px; padding: 20px;">
            <div class="marcas"><img class="carrostoyota" src="assets/img/toyota.png" alt="Toyota" /></div>
            <div class="marcas"><img class="carros" src="assets/img/chevrolot.png" alt="Chevrolet" /></div>
            <div class="marcas"><img class="carrosram" src="assets/img/ram.png" alt="Ram" /></div>
            <div class="marcas"><img class="carrosjeep" src="assets/img/jeep.png" alt="Jeep" /></div>
            <div class="marcas"><img class="carrosfiat" src="assets/img/fiat.png" alt="Fiat" /></div>
            <div class="marcas"><img class="carrosnissan" src="assets/img/nissan.png" alt="Nissan" /></div>
        </div>
    </section>

    <section class="explorecatalogo-section">
        <h3 class="center txt-catalogo">Explore nosso catálogo</h3>
    </section>

    <section class="background-cinza">
        <div class="catalogo-section" id="produtos">
            <!-- cards serão injetados aqui -->
        </div>
    </section>

    <section class="banner2" style="margin-top: -40px;">
        <img class="banner2" src="assets/img/PONTEIRAS DE.png" alt="Banner 2" />
    </section>

    <footer class="center" style="background-color: black;">
        <img class="logo-footer" src="assets/img/Ariel.png" alt="Logo Footer" />
        <p class="p-cadastro2">AutoPrime © 2025 - Todos os direitos reservados</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // menu lateral
            const avatarToggle = document.getElementById('avatarToggle');
            const sideMenu = document.getElementById('sideMenu');
            const menuClose = document.getElementById('menuClose');

            avatarToggle?.addEventListener('click', (e) => { e.preventDefault(); sideMenu.classList.add('active'); });
            menuClose?.addEventListener('click', () => sideMenu.classList.remove('active'));

            // logout
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn?.addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.clear();
                if (typeof Swal !== 'undefined') {
                    Swal.fire({ icon: 'success', title: 'Logout realizado!', text: 'Você será redirecionado para a página de login.', confirmButtonText: 'Ok' })
                        .then(() => window.location.href = 'login.html');
                } else {
                    alert('Logout realizado! Redirecionando...');
                    window.location.href = 'login.html';
                }
            });

            // listar produtos (com Nome, Descrição, Acabamento e Preço no card)
            async function listarProdutos() {
                const token = localStorage.getItem("token");
                const busca = document.getElementById('buscaInput')?.value?.trim() || '';
                const headers = new Headers();
                headers.append("Content-Type", "application/json");
                if (token) headers.append("Authorization", `Bearer ${token}`);

                const urlBase = "http://192.168.1.121:5000/produtos";
                const url = busca ? `${urlBase}?q=${encodeURIComponent(busca)}` : urlBase;

                try {
                    const resp = await fetch(url, { method: 'GET', headers, redirect: 'follow' });
                    if (!resp.ok) throw new Error('Erro ao buscar produtos');
                    const data = await resp.json();
                    const produos = data.produtos || data || [];
                    const container = document.getElementById('produtos');
                    container.innerHTML = '';

                    if (!produos.length) {
                        container.innerHTML = '<p style="padding:20px;">Nenhum produto encontrado.</p>';
                        return;
                    }

                    const frag = document.createDocumentFragment();

                    produos.forEach(produto => {
                        const card = document.createElement('article');
                        card.className = 'meus-produtos';
                        card.dataset.id = produto.id ?? '';

                        // imagem
                        const img = document.createElement('img');
                        img.className = 'img-produto';
                        img.alt = produto.nome || 'Produto';
                        img.src = produto.imagem ? `http://192.168.1.121:5000/static/imagens/${produto.imagem}` : 'assets/img/ponta 5.png';
                        img.onerror = () => { img.src = 'assets/img/ponta 5.png'; };

                        // conteúdo
                        const content = document.createElement('div');
                        content.className = 'card-content';

                        const nome = document.createElement('h3');
                        nome.className = 'nome-produto';
                        nome.textContent = produto.nome || 'Produto sem nome';

                        const descricao = document.createElement('p');
                        descricao.className = 'descricao-produto';
                        const descText = produto.descricao ? String(produto.descricao).trim() : 'Sem descrição';
                        descricao.textContent = descText;
                        descricao.setAttribute('title', descText); // tooltip com descrição completa

                        const acabamento = document.createElement('div');
                        acabamento.className = 'acabamento-produto';
                        acabamento.textContent = produto.acabamento ? `Acabamento: ${produto.acabamento}` : 'Acabamento: -';

                        // rodapé com preço + botão comprar
                        const rodape = document.createElement('div');
                        rodape.className = 'rodape-card';

                        const preco = document.createElement('div');
                        preco.className = 'preco-produto';
                        // formata preço
                        let precoFormat = produto.preco;
                        if (typeof produto.preco === 'number') precoFormat = produto.preco.toFixed(2).replace('.', ',');
                        else if (typeof produto.preco === 'string') precoFormat = produto.preco.replace('.', ',');
                        preco.textContent = `R$ ${precoFormat ?? '0,00'}`;

                        const comprar = document.createElement('a');
                        comprar.className = 'btn-comprar';
                        // monta query params de forma segura
                        const params = new URLSearchParams({
                            id: produto.id ?? '',
                            nome: produto.nome ?? '',
                            descricao: produto.descricao ?? '',
                            preco: produto.preco ?? '',
                            acabamento: produto.acabamento ?? '',
                            marca: produto.marca ?? '',
                            imagem: produto.imagem ?? ''
                        });
                        comprar.href = `comprar.html?${params.toString()}`;
                        comprar.textContent = 'Comprar';

                        // monta card
                        content.appendChild(nome);
                        content.appendChild(descricao);
                        content.appendChild(acabamento);
                        rodape.appendChild(preco);
                        rodape.appendChild(comprar);
                        card.appendChild(img);
                        card.appendChild(content);
                        card.appendChild(rodape);

                        frag.appendChild(card);
                    });

                    container.appendChild(frag);

                } catch (err) {
                    console.error('Erro listarProdutos:', err);
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível carregar os produtos. Verifique o servidor.' });
                    } else {
                        alert('Não foi possível carregar os produtos. Verifique o servidor.');
                    }
                }
            }

            // expõe pra console
            window.listarProdutos = listarProdutos;

            // chama
            listarProdutos();
        });
    </script>
</body>

</html>

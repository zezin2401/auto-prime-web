<!DOCTYPE html>
<html lang="pt-br" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seu Cashback</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/cashbackvendedor.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">



    <style>
        #sideMenu {
            position: fixed;
            top: 0;
            right: -250px;
            width: 250px;
            height: 100%;
            background-color: #222;
            color: #f0f0f0;
            box-shadow: -3px 0 8px rgba(0, 0, 0, 0.6);
            transition: right .3s ease, opacity .3s ease;
            padding: 30px 25px;
            font-family: 'Poppins', sans-serif;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
        }

        #sideMenu.active {
            right: 0;
            opacity: 1;
            pointer-events: auto;
        }

        #sideMenu .closeBtn {
            font-size: 28px;
            font-weight: 700;
            cursor: pointer;
            text-align: right;
            margin-bottom: 40px;
            color: #f0f0f0;
            user-select: none;
            transition: color .2s;
        }

        #sideMenu .closeBtn:hover {
            color: #ff4d4d;
        }

        #sideMenu ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        #sideMenu ul li {
            font-weight: 600;
            font-size: 20px;
        }

        #sideMenu ul li a {
            color: #f0f0f0;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 8px;
            display: block;
        }

        #sideMenu ul li a:hover {
            background: #444;
            color: #ff4d4d;
        }
    </style>
</head>

<body>
    <header>
        <a href="indexvendedor.html"><img class="logo" src="assets/img/Ariel.png" alt="Logo"></a>

        <a class="avatarheader" href="#" id="avatarToggle"><img src="assets/img/login 3.png" alt="Avatar" /></a>
    </header>

    <div id="menuOverlay" class="menu-overlay"
        style="position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:999;opacity:0;pointer-events:none;transition:opacity .18s;">
    </div>

    <!-- ========== MENU LATERAL ========== -->
    <nav id="sideMenu">
        <div class="closeBtn" id="menuClose">&times;</div>
        <ul>
            <li><a href="#">Minha Conta</a></li>
            <li><a href="#" id="logoutBtn">Logout</a></li>
        </ul>
    </nav>


    <section class="banner">
        <img src="assets/img/PONTEIRAS DE 1.png" alt="">
    </section>

    <section class="main">

        <h1>Gerenciar seu cashback e vendas</h1>

        <div class="botoes">

            <a href="usuarios.html" class="botao-gerenciar"><i class="fa-solid fa-user"></i>Gerenciar Usuários</a>

            <a href="vendas.html" class="botao-gerenciar"><i class="fa-solid fa-cart-shopping"></i>Gerenciar Vendas</a>

            <a href="produtos.html" class="botao-gerenciar"><i class="fa-solid fa-bag-shopping"></i>Gerenciar
                Produtos</a>

            <a href="cashback.html" class="botao-gerenciar"><i class="fa-solid fa-dollar-sign"></i>Gerenciar
                Cashback</a>

        </div>

        <div class="div-azul">
            <h2 class="titulo">Seu cashback acumulado</h2>
            <h2 class="capital" id="cashbackValor">R$: 0,00</h2>

        </div>

        <div class="vendedores" id="listaVendas">

            <h3 class="titulo-historico">Seu Histórico de Vendas</h3>

            <table class="tutorial">
                <tbody id="tabelaVendas">
                    <!-- As linhas serão inseridas aqui via innerHTML -->
                </tbody>
            </table>

        </div>

    </section>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const BASE = "http://10.92.3.165:5000";

            // pega id do vendedor/usuário
            const id = localStorage.getItem("id_cadastro") ||
                localStorage.getItem("id_vendedor") ||
                "50";

            /* ================= CASHBACK ================= */
            try {
                const resp = await fetch(`${BASE}/cashback/total/${id}`);
                const dados = await resp.json();

                document.getElementById("cashbackValor").innerText =
                    `R$: ${dados.total_cashback.toFixed(2)}`;
            } catch (e) {
                console.error("Erro ao pegar cashback:", e);
                document.getElementById("cashbackValor").innerText = "Erro";
            }

            /* ============= FUNÇÕES AUXILIARES ============= */
            function esc(s = "") {
                return String(s === null || s === undefined ? "" : s)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }

            function fmtDate(iso) {
                try {
                    const d = new Date(iso);
                    if (isNaN(d)) return esc(iso);
                    return d.toLocaleString("pt-BR", {
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                        hour: "2-digit",
                        minute: "2-digit"
                    });
                } catch (e) {
                    return esc(String(iso));
                }
            }

            function fmtMoney(n) {
                const v = Number(n || 0);
                return v.toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL"
                });
            }

            /* =========== HISTÓRICO DE VENDAS (VERSÃO CORRETA) =========== */
            try {
                const res = await fetch(`${BASE}/historico_vendas/${id}`);
                const data = await res.json();

                const historico = Array.isArray(data.historico) ? data.historico : [];

                const tbody = document.getElementById("tabelaVendas");

                let html = `
            <tr>
                <th class="tutorial_id_venda"><p class="id">Cod.</p></th>
                <th class="tutorial_data_venda"><p class="data">Data da venda</p></th>
                <th class="tutorial_cliente"><p class="nome_cliente">Nome do Cliente</p></th>
                <th class="tutorial_produto_comprado"><p class="produto">Produto Comprado</p></th>
                <th class="tutorial_quantidade"><p class="qtd">Quantidade</p></th>
                <th class="tutorial_valor_total"><p class="total">Subtotal</p></th>
            </tr>
        `;

                if (historico.length === 0) {
                    html += `
                <tr>
                    <td colspan="6" style="padding:12px;text-align:center;color:#666">
                        Nenhuma venda encontrada.
                    </td>
                </tr>
            `;
                } else {
                    historico.forEach(v => {
                        html += `
                    <tr>
                        <td class="id_venda"><p class="id">#${esc(v.id_venda)}</p></td>
                        <td class="data_venda"><p class="data">${fmtDate(v.data_venda)}</p></td>
                        <td class="cliente"><p class="nome_cliente">${esc(v.nome_cliente ?? "Cliente " + v.id_cliente)}</p></td>
                        <td class="produto_comprado"><p class="produto">${esc(v.nome_produto ?? "Produto " + v.id_produto)}</p></td>
                        <td class="quantidade"><p class="qtd">${esc(v.quantidade)}</p></td>
                        <td class="valor_total"><p class="total">${fmtMoney(v.valor_total)}</p></td>
                    </tr>
                `;
                    });
                }

                tbody.innerHTML = html;
            } catch (err) {
                console.error("Erro ao carregar histórico:", err);
                document.getElementById("tabelaVendas").innerHTML =
                    `<tr><td colspan="6" style="padding:12px;color:#c00">Erro ao carregar histórico.</td></tr>`;
            }
        });
    </script>
</body>

</html>